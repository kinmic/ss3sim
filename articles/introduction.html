<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to ss3sim • ss3sim</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Introduction to ss3sim">
<meta property="og:description" content="Start here to learn how to use ss3sim. Basic information is provided on key functions, e.g., [run_ss3sim()], and available outputs.
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ss3sim</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Introduction to ss3sim</a>
    </li>
    <li>
      <a href="../articles/making-models.html">Creating new ss3sim model setups</a>
    </li>
    <li>
      <a href="../articles/modifying-models.html">Modifying the model included with ss3sim</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ss3sim/ss3sim/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="introduction_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to ss3sim</h1>
            
            <h4 class="date">2021-11-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ss3sim/ss3sim/blob/master/vignettes/introduction.Rmd"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="hidden name"><code>introduction.Rmd</code></div>

    </div>

    
    
<p>This vignette is a good starting place for learning about ss3sim.</p>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>ss3sim is an R package to simplify the steps needed to generate beautiful simulation output from <a href="https://github.com/nmfs-stock-synthesis/stock-synthesis" title="Stock Synthesis (SS3) github repository">Stock Synthesis (SS3)</a>. If you need help learning R prior to using ss3sim, we recommend navigating to the <a href="https://blog.rstudio.org/" title="RStudio Blog">RStudio Blog</a>.</p>
<p>ss3sim consists of</p>
<ul>
<li>a series of low-level functions that facilitate manipulating Stock Synthesis configuration files, running Stock Synthesis models, and combining the output</li>
<li>a few high-level wrapper functions that control simulation experiments, e.g., [run_ss3sim()]</li>
<li>documentation for the user, e.g., <code><a href="../reference/change_f.html">?change_f</a></code>, vignettes, <a href="https://github.com/ss3sim/ss3sim/issues" title="ss3sim issue tracker on GitHub">issue tracker</a>, and a <a href="https://github.com/ss3sim/ss3sim/discussions" title="ss3sim Discussions on GitHub">Discussion board</a> for users and developers to interact.</li>
</ul>
<p>The developers of ss3sim strive to facilitate an inviting place where all individuals feel welcome. Please see the <a href="https://github.com/nmfs-fish-tools/Resources/blob/master/CODE_OF_CONDUCT.md" title="Code of Conduct">Code of Conduct</a> that we abide by to ensure contributors are valued and <a href="https://github.com/nmfs-fish-tools/Resources/blob/master/CONTRIBUTING.md" title="Contributor guidelines">Contributor Guidelines</a> for how to contribute.</p>
<div id="stock-synthesis" class="section level2">
<h2 class="hasAnchor">
<a href="#stock-synthesis" class="anchor"></a>Stock Synthesis</h2>
<p>It seems imperative to first describe <a href="https://github.com/nmfs-stock-synthesis/stock-synthesis" title="Stock Synthesis (SS3) github repository">Stock Synthesis</a> because without Stock Synthesis there would not be ss3sim. Stock Synthesis is an integrated statistical catch-at-age model written in <a href="https://www.admb-project.org/community/" title="AD model builder project">ADMB</a>. The software is widely used across the globe and has been around for 40+ years.</p>
<p>The inspiration for ss3sim came from Hui-Hua Lee’s hooilator software. hooliator parsed <code>data.ss_new</code> files into multiple files and created a consistent directory structure to store the results. These <code>ss_new</code> files are produced by Stock Synthesis, such that output that contains expected values is available with consistent formatting. The developers of ss3sim built off of the ideas within hooliator and added functions to sample from the expected values. Sampling from expected values was atypical, where most simulations typically relied on bootstrapped values that were provided in the Stock Synthesis output. With a plethora of simulation output stored in structured folders, there was an imminent need for functions to visualize the results. <a href="https://ggplot2.tidyverse.org/" title="ggplot2 documentation">ggplot2</a> was gaining traction at the time and shaped how we thought about things, including our <a href="#overview">mission statement</a> and <a href="beautiful-output">example output</a>.</p>
<p>ss3sim is just a minor part of the suite of functionality available for Stock Synthesis. See the <a href="https://github.com/nmfs-stock-synthesis/stock-synthesis" title="Stock Synthesis (SS3) github repository">Stock Synthesis website</a> for a list of additional software.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<div id="installing-ss3sim" class="section level3">
<h3 class="hasAnchor">
<a href="#installing-ss3sim" class="anchor"></a>Installing ss3sim</h3>
<p>ss3sim is available on <a href="https://cran.r-project.org/package=ss3sim" title="ss3sim on CRAN">CRAN</a> and <a href="https://github.com/ss3sim/ss3sim/releases" title="ss3sim on GitHub">GitHub</a> and can be run on OS X, Windows, or Linux. The GitHub branch “main” contains the newest features, which may not available on CRAN.</p>
<p>Run the following code to install ss3sim and load it into your workspace. You will not need to install ss3sim every time but it is a good idea to ensure it is up to date. If you are installing from GitHub, R will let you know if your current version is up to date.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># CRAN version</span>
<span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"ss3sim"</span><span class="op">)</span>
<span class="co"># install.packages("remotes")</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span>
  repo <span class="op">=</span> <span class="st">"ss3sim/ss3sim"</span>,
  dependencies <span class="op">=</span> <span class="cn">TRUE</span>, upgrade <span class="op">=</span> <span class="cn">FALSE</span>, build_vignettes <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load the package</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/ss3sim/ss3sim">"ss3sim"</a></span><span class="op">)</span></code></pre></div>
<p>The following code demonstrates how to access the ss3sim documentation within R. You can also view the <a href="https://ss3sim.github.io/ss3sim/" title="ss3sim website hosted on GitHub">vignettes online</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">?</span><span class="va">ss3sim</span>
<span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/help.html">help</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"ss3sim"</span><span class="op">)</span>
<span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/browseVignettes.html">browseVignettes</a></span><span class="op">(</span><span class="st">"ss3sim"</span><span class="op">)</span></code></pre></div>
</div>
<div id="installing-stock-synthesis" class="section level3">
<h3 class="hasAnchor">
<a href="#installing-stock-synthesis" class="anchor"></a>Installing Stock Synthesis</h3>
<p>ss3sim relies the Stock Synthesis executable being available to the operating system regardless of the directory. Thus, <code>ss</code> or <code>ss.exe</code> must <a href="#path">be in your path</a>, which is a list of directories that your operating system has access to. Your operating system will search directories listed in your path when searching for programs. Having <a href="#path">Stock Synthesis in your path</a> allows users to use just the name of the executable and not the full file path in a shell and run the executable in a directory without copying it to the directory. This functionality of not copying the executable works even when <a href="#parallel">running Stock Synthesis in parallel</a>. This approach saves on storage space because the Stock Synthesis binary is about 6 MB. It also facilitates manually running models during development and testing. For example, you might be trying to create input files for a new simulation, where the simulation is based on a life history that you are interested in. Having Stock Synthesis in your path allows you to open a shell prompt in the directory with your Stock Synthesis input files and run the Stock Synthesis executable by typing <code>ss</code>. Debugging can be facilitated by</p>
<ul>
<li>output that is printed to the console,</li>
<li>echoinput.sso, and</li>
<li>Report.sso.</li>
</ul>
<p>ss3sim was originally based on Stock Synthesis 3.24O <span class="citation">(Anderson et al. 2014)</span>. At first, ss3sim did not keep up to date with newer versions of Stock Synthesis. In 2019, ss3sim was updated to use Stock Synthesis 3.30. <strong>Users can count on future versions of ss3sim being up to date with the newest version of Stock Synthesis.</strong> Stock Synthesis will end development with major-version three, hence the name ss3sim. But, minor versions will continue to be updated for quite some time.</p>
<div id="executables" class="section level4">
<h4 class="hasAnchor">
<a href="#executables" class="anchor"></a>Executables</h4>
<p>Compiled Stock Synthesis executables are available for multiple operating systems at the following locations:</p>
<ul>
<li>available <a href="https://github.com/ss3sim/ss3sim/tree/main/inst/bin" title="Stock Synthesis executables on GitHub in ss3sim">on github</a>,</li>
<li>available <a href="https://github.com/nmfs-stock-synthesis/stock-synthesis/actions" title="Stock Synthesis GitHub actions">within GitHub actions in the Stock Synthesis GitHub repository</a>, or</li>
<li>are downloaded automatically when you use the GitHub version of ss3sim.</li>
</ul>
</div>
<div id="path" class="section level4">
<h4 class="hasAnchor">
<a href="#path" class="anchor"></a>Putting Stock Synthesis in your path</h4>
<p>ss3sim will first look to see if the executable is available in your R library using <code>system.file("bin", package = "ss3sim")</code>. The previous will only lead to a viable file path if you are using the GitHub version of ss3sim because the distribution of executables is not allowed on CRAN. If the location is not returned from <code>system.file</code>, R will look for the executable in your path. This hierarchy is important for understanding which version of Stock Synthesis is being used.</p>
<p>If you are using the CRAN version of ss3sim, reference the <a href="https://nmfs-stock-synthesis.github.io/ss-documentation/Getting_Started_SS.html" title="Stock Synthesis Getting Started documentation">Getting Started with Stock Synthesis documentation</a> for instructions on how to put Stock Synthesis in your path.</p>
</div>
</div>
<div id="installing-dependent-r-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#installing-dependent-r-packages" class="anchor"></a>Installing dependent R packages</h3>
<p>Below we highlight a few packages that are essential for running ss3sim.</p>
<div id="remotes" class="section level4">
<h4 class="hasAnchor">
<a href="#remotes" class="anchor"></a>remotes</h4>
<p>If you want to use the GitHub version of any R package, you will need to install the <a href="https://remotes.r-lib.org/" title="remotes R package">remotes package</a> first. remotes can either be installed directly using <code>install.packages("remotes")</code> or will be available if you have <a href="https://devtools.r-lib.org/" title="devtools R package">devtools</a>.</p>
</div>
<div id="r4ss" class="section level4">
<h4 class="hasAnchor">
<a href="#r4ss" class="anchor"></a>r4ss</h4>
<p>If you are using the GitHub version of ss3sim, R will install the <a href="https://github.com/r4ss/r4ss" title="r4ss on GitHub">GitHub version of r4ss</a>. If you are using the CRAN version of ss3sim, R will install the <a href="https://cran.r-project.org/package=r4ss" title="r4ss on CRAN">CRAN version of r4ss</a>. Both methods will check to make sure that you have the most recent version of r4ss in your R library available given which mirror you are using. Feel free to install r4ss directly via</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>remotes<span class="op">::</span><span class="kw">install_github</span>(</span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="st">"r4ss/r4ss"</span>,</span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="dt">dependencies =</span> <span class="ot">TRUE</span>, <span class="dt">upgrade =</span> <span class="ot">FALSE</span>, <span class="dt">build_vignettes =</span> <span class="ot">TRUE</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>)<span class="st">`</span></span></code></pre></div>
<p>But, make sure you do it before loading ss3sim. If you forget, you can use <code>devtools::unload(package = "ss3sim")</code> and then reinstall r4ss.</p>
</div>
<div id="ggplot2" class="section level4">
<h4 class="hasAnchor">
<a href="#ggplot2" class="anchor"></a>ggplot2</h4>
<p><a href="https://ggplot2.tidyverse.org/" title="ggplot2 documentation">ggplot2</a> uses the <a href="https://www.amazon.com/Grammar-Graphics-Statistics-Computing/dp/0387245448/ref=as_li_ss_tl" title="Grammar of Graphics on Amazon">Grammar of Graphics</a> to decoratively create images that represent things in a tidy way. We do not force users to use ggplot2. All output is available as csv files and can be visualized using base R if you prefer. The easiest way to get ggplot2 is to install the whole tidyverse suite</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"tidyverse"</span><span class="op">)</span></code></pre></div>
</div>
</div>
</div>
<div id="scenarios" class="section level2">
<h2 class="hasAnchor">
<a href="#scenarios" class="anchor"></a>Scenarios</h2>
<p>Simulations are composed of scenarios, i.e., unique sets of changes to the OM and EM. <code><a href="../reference/run_ss3sim.html">run_ss3sim()</a></code> uses <code>simdf</code> to specify the setup of scenarios within a simulation. <code>simdf</code> stands for simulation data frame. The rows of the data frame store scenario-level information. The columns of the data frame store function arguments. Arguments can be direct arguments of <code><a href="../reference/ss3sim_base.html">ss3sim_base()</a></code> or functions called by <code><a href="../reference/ss3sim_base.html">ss3sim_base()</a></code> such as <code><a href="../reference/change_f.html">change_f()</a></code>. You only need to specify columns for the arguments that you want to change. That is, you do not have to have a column for every argument of all functions called by <code><a href="../reference/ss3sim_base.html">ss3sim_base()</a></code>. To get a feel for the columns needed in the <code>simdf</code> data frame run the following code, where the output can be saved and used to build <code>simdf</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup_scenarios_defaults.html">setup_scenarios_defaults</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># Get standard errors by turning on the hessian</span>
<span class="va">simdf</span><span class="op">[</span>, <span class="st">"hess_always"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></code></pre></div>
<p>Column entries of <code>simdf</code> need to be quoted if they are to be evaluated later, e.g., <code>"seq(1,10,by=2)"</code> and <code>"c('NatM_p_1_Fem_GP_1', 'L_at_Amin_Fem_GP_1')"</code>. Scalar values can numeric. Use single quotes inside of double quotes to quote text. Developers of ss3sim are working on a better, more tidyverse-like non-standard evaluation method such that quotes will not be needed. Feel free to reach out if you would like to help with this effort or have ideas on how to make it work better.</p>
<p>Column names of <code>simdf</code> are key. In the example above, <code>hess_always</code> is an argument of <code><a href="../reference/ss3sim_base.html">ss3sim_base()</a></code> and can be used directly as the column name. In fact, you can specify any input argument to <code><a href="../reference/ss3sim_base.html">ss3sim_base()</a></code> as a column of <code>simdf</code>.</p>
<table class="table">
<thead><tr class="header">
<th>ss3sim function</th>
<th align="left">Argument</th>
<th align="right">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>ss3sim_base</code></td>
<td align="left"><code>bias_adjust</code></td>
<td align="right">Perform bias adjustment</td>
</tr>
<tr class="even">
<td><code>ss3sim_base</code></td>
<td align="left"><code>hess_always</code></td>
<td align="right">Calculate hessian</td>
</tr>
</tbody>
</table>
<p>For functions that are called by <code><a href="../reference/ss3sim_base.html">ss3sim_base()</a></code> you need to use the following rules to create appropriate column names:</p>
<ul>
<li>abbreviation of the function name (see the table below),</li>
<li>full stop,</li>
<li>the argument name,</li>
<li>full stop, and</li>
<li>integers to specify which fleet the column pertains to.</li>
</ul>
<p>For example, <code>cf.years.1</code> passes information to the <code>year</code> argument of <code><a href="../reference/change_f.html">change_f()</a></code> for fleet 1. <code>cf.years.2</code> passes information to the <code>year</code> argument of <code><a href="../reference/change_f.html">change_f()</a></code> for fleet 2. Function abbreviations are as follows:</p>
<table class="table">
<thead><tr class="header">
<th>ss3sim function</th>
<th align="left">Prefix</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/change_f.html">change_f()</a></code></td>
<td align="left"><code>cf.</code></td>
<td>Fishing mortality</td>
</tr>
<tr class="even">
<td><code><a href="../reference/change_e.html">change_e()</a></code></td>
<td align="left"><code>ce.</code></td>
<td>Estimation</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/change_o.html">change_o()</a></code></td>
<td align="left"><code>co.</code></td>
<td>Operating model</td>
</tr>
<tr class="even">
<td><code><a href="../reference/change_tv.html">change_tv()</a></code></td>
<td align="left"><code>ct.</code></td>
<td>Time-varying OM parameter</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/change_data.html">change_data()</a></code></td>
<td align="left"><code>cd.</code></td>
<td>Available OM data, bins, etc.</td>
</tr>
<tr class="even">
<td><code><a href="../reference/change_em_binning.html">change_em_binning()</a></code></td>
<td align="left"><code>cb.</code></td>
<td>Available EM data bins</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/change_retro.html">change_retro()</a></code></td>
<td align="left"><code>cr.</code></td>
<td>Retrospective year</td>
</tr>
<tr class="even">
<td><code><a href="../reference/sample_index.html">sample_index()</a></code></td>
<td align="left"><code>si.</code></td>
<td>Index data</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/sample_agecomp.html">sample_agecomp()</a></code></td>
<td align="left"><code>sa.</code></td>
<td>Age-composition data</td>
</tr>
<tr class="even">
<td><code><a href="../reference/sample_lcomp.html">sample_lcomp()</a></code></td>
<td align="left"><code>sl.</code></td>
<td>Length-composition data</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/sample_calcomp.html">sample_calcomp()</a></code></td>
<td align="left"><code>sc.</code></td>
<td>Conditional age-at-length data</td>
</tr>
<tr class="even">
<td><code><a href="../reference/sample_mlacomp.html">sample_mlacomp()</a></code></td>
<td align="left"><code>sm.</code></td>
<td>Mean length-at-age data</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/sample_wtatage.html">sample_wtatage()</a></code></td>
<td align="left"><code>sw.</code></td>
<td>Weight-at-age data</td>
</tr>
</tbody>
</table>
<p>Currently, fishing mortality, indices of abundance, and either age- or length-composition data are mandatory for a scenario.</p>
</div>
<div id="file-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#file-structure" class="anchor"></a>File structure</h2>
<div id="input-file-structure" class="section level3">
<h3 class="hasAnchor">
<a href="#input-file-structure" class="anchor"></a>Input file structure</h3>
<p>The ss3sim package comes with a generic, built-in operating model (OM) and estimation method (EM). The life history for these available files is based on a cod-like fish. You can peruse the files if you have ss3sim installed here</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/models"</span>, package <span class="op">=</span> <span class="st">"ss3sim"</span><span class="op">)</span></code></pre></div>
<p>These model files can be used as is, modified, or replaced. For more details on how to modify or replace the default models, see the vignettes on <a href="modifying-models.html">modifying model setups</a> and <a href="making-models.html">creating your own OM and EMs</a>.</p>
<p>You can have as many OMs and EMs as you want in your simulation. The collection of files for each OM and EM should be in its own directory, just like the example OM and EM.</p>
</div>
<div id="simulation-file-structure" class="section level3">
<h3 class="hasAnchor">
<a href="#simulation-file-structure" class="anchor"></a>Simulation file structure</h3>
<p>Internally, <code><a href="../reference/copy_ss3models.html">copy_ss3models()</a></code> creates the directory structure for the simulations. After you run a simulation, directories will be created in your working directory. Inside your working directory, the structure will look like</p>
<pre><code>  scenarioA/1/om
  scenarioA/1/em
  scenarioA/2/om
  scenarioA/2/em
  scenarioB/1/om
  scenarioB/1/em
  ...</code></pre>
<p>The integer values after the scenario represent iterations; the total number of iterations is specified by the user. The OM and EM directories are copied into individual directories for an iteration. Note that the supplied OM and EM directories will be renamed <code>om</code> and <code>em</code> within each iteration. There will be some additional directories if you are using bias adjustment. See <code><a href="../reference/ss3sim_base.html">ss3sim_base()</a></code> for more information on bias adjustment. You can name the scenarios any combination of character values or use the default naming system within ss3sim that uses the date and time.</p>
<p>The supplied OM and EM directories are checked to ensure</p>
<ul>
<li>they contain the minimal files,</li>
<li>the filenames are lowercase,</li>
<li>the data file is named <code>ss.dat</code>,</li>
<li>the control files are named <code>om.ctl</code> or <code>em.ctl</code>, and</li>
<li>the starter files are adjusted to reflect these file names.</li>
</ul>
</div>
</div>
</div>
<div id="example" class="section level1">
<h1 class="hasAnchor">
<a href="#example" class="anchor"></a>Example simulations with ss3sim</h1>
<p>The example is based on the cod-like species in the papers <span class="citation">Ono et al. (2015)</span> and <span class="citation">Johnson et al. (2015)</span>, both of which used the ss3sim package. All of the required files for this example are contained within the ss3sim package. This example is a 2x2 design, testing</p>
<ol style="list-style-type: decimal">
<li>the effect of high and low precision on the index of abundance provided by the survey and</li>
<li>the effect of fixing versus estimating natural mortality (<span class="math inline">\(M\)</span>).</li>
</ol>
<div id="setting-up-the-example" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-up-the-example" class="anchor"></a>Setting up the example</h2>
<p>First we will create <code>df</code>, a data frame for <code>run_ss3sim(simdf = df)</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Use the boiler-plate data frame available in the package for 2 scenarios</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup_scenarios_defaults.html">setup_scenarios_defaults</a></span><span class="op">(</span>nscenarios <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co"># Turn off bias adjustment and use default settings in cod EM model</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"bias_adjust"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="co"># Estimate the hessian</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"hess_always"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></code></pre></div>
<div id="fishing-mortality" class="section level3">
<h3 class="hasAnchor">
<a href="#fishing-mortality" class="anchor"></a>Fishing mortality</h3>
<p>Fishing mortality, <span class="math inline">\(F\)</span>, is set to a constant percentage of <span class="math inline">\(F\)</span> at maximum sustainable yield, <span class="math inline">\(F_\mathrm{MSY}\)</span>, from when the fishery starts in year 26 until the end of the simulation in year 100.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Display the default fishing mortality settings</span>
<span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^cf\\."</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt;   cf.years.1      cf.fvals.1</span>
<span class="co">#&gt; 1     26:100 rep(0.1052, 75)</span>
<span class="co">#&gt; 2     26:100 rep(0.1052, 75)</span></code></pre></div>
</div>
<div id="composition-data" class="section level3">
<h3 class="hasAnchor">
<a href="#composition-data" class="anchor"></a>Composition data</h3>
<p>Refer to the help files <code><a href="../reference/sample_lcomp.html">?sample_lcomp</a></code> and <code><a href="../reference/sample_agecomp.html">?sample_agecomp</a></code> for detailed information on these functions. The sampling theory is described in the <a href="#comps">age- and length-composition sampling section</a>.</p>
<p>The default <code>simdf</code> contains sampling protocols for composition data.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Display the default composition-data settings</span>
<span class="co"># sa is for ages and sl is for lengths</span>
<span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^s[al]\\."</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt;   sl.Nsamp.1 sl.years.1 sl.Nsamp.2           sl.years.2 sl.cpar sa.Nsamp.1</span>
<span class="co">#&gt; 1         50     26:100        100 seq(62, 100, by = 2)    NULL         50</span>
<span class="co">#&gt; 2         50     26:100        100 seq(62, 100, by = 2)    NULL         50</span>
<span class="co">#&gt;   sa.years.1 sa.Nsamp.2           sa.years.2 sa.cpar</span>
<span class="co">#&gt; 1     26:100        100 seq(62, 100, by = 2)    NULL</span>
<span class="co">#&gt; 2     26:100        100 seq(62, 100, by = 2)    NULL</span></code></pre></div>
</div>
<div id="survey-index-of-abundance" class="section level3">
<h3 class="hasAnchor">
<a href="#survey-index-of-abundance" class="anchor"></a>Survey index of abundance</h3>
<p>To investigate the effect of different levels of precision on the survey index of abundance, we will manipulate <code>sds_obs</code> of <code><a href="../reference/sample_index.html">sample_index()</a></code>. This argument ultimately refers to the standard error of the natural log of yearly index values, as defined in Stock Synthesis. In the first scenario <code>sds_obs = 0.1</code>. In the second scenario <code>sds_obs = 0.4</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create a biennial survey starting in year 76 and ending in the terminal year</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"si.years.2"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"seq(76, 100, by = 2)"</span>
<span class="co"># Set sd of observation error for each scenario</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"si.sds_obs.2"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.4</span><span class="op">)</span></code></pre></div>
</div>
<div id="estimating-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-parameters" class="anchor"></a>Estimating parameters</h3>
<p>To investigate the effect of fixing versus estimating <span class="math inline">\(M\)</span>, <code>df</code> must be augmented to call <code><a href="../reference/change_e.html">change_e()</a></code>. Using <code>par_phase</code> one can turn a parameter on and off in the EM, where negative phases tells Stock Synthesis to not estimate the parameter. The second scenario will estimate <span class="math inline">\(M\)</span> in phase <code>3</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df</span><span class="op">)</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"ce.par_name"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"NatM_p_1_Fem_GP_1"</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"ce.par_int"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
<span class="co"># Set the phase for estimating natural mortality</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"ce.par_phase"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co"># Name the scenarios</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"scenarios"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D0-E0-F0-cod"</span>, <span class="st">"D1-E0-F0-cod"</span>,
  <span class="st">"D0-E1-F0-cod"</span>, <span class="st">"D1-E1-F0-cod"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="visualizing-the-results" class="section level2">
<h2 class="hasAnchor">
<a href="#visualizing-the-results" class="anchor"></a>Visualizing the results</h2>
<p>Five iterations is unrealistic for a manuscript but saves time and disk space here. You can assess how many iterations are needed to stabilize the results using <code><a href="../reference/plot_cummean.html">plot_cummean()</a></code>, which plots the mean relative error on the y as additional iterations. The goal is to run plenty of iterations, such that additional iterations no longer appreciably flatten the curve towards a relative error of zero.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iterations</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>
<span class="va">scname</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ss3sim.html">run_ss3sim</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="va">iterations</span>, simdf <span class="op">=</span> <span class="va">df</span><span class="op">)</span></code></pre></div>
<p>A quick test that can be helpful is visualizing the patterns of spawning stock biomass from the OM and the EM using r4ss.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r_om</span> <span class="op">&lt;-</span> <span class="fu">r4ss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/r4ss/man/SS_output.html">SS_output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">scname</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"1"</span>, <span class="st">"om"</span><span class="op">)</span>,
  verbose <span class="op">=</span> <span class="cn">FALSE</span>, printstats <span class="op">=</span> <span class="cn">FALSE</span>, covar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">r_em</span> <span class="op">&lt;-</span> <span class="fu">r4ss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/r4ss/man/SS_output.html">SS_output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">scname</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"1"</span>, <span class="st">"em"</span><span class="op">)</span>,
  verbose <span class="op">=</span> <span class="cn">FALSE</span>, printstats <span class="op">=</span> <span class="cn">FALSE</span>, covar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu">r4ss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/r4ss/man/SSplotComparisons.html">SSplotComparisons</a></span><span class="op">(</span><span class="fu">r4ss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/r4ss/man/SSsummarize.html">SSsummarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">r_om</span>, <span class="va">r_em</span><span class="op">)</span><span class="op">)</span>,
  legendlabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"OM"</span>, <span class="st">"EM"</span><span class="op">)</span>, subplots <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>Each iteration is unique because of process error included through normally-distributed recruitment deviations. Thus, if you were to plot the OMs from iteration one and two using <code><a href="https://rdrr.io/pkg/r4ss/man/SSplotComparisons.html">r4ss::SSplotComparisons()</a></code> there would be clear annual differences. Deviations are generated for each iteration in your simulation and used across scenarios. Using the same deviations for iteration one of each scenario, and a different set of deviations for each additional iteration, facilitates comparisons across scenarios. The default distribution in ss3sim has a mean of <code>-0.5</code> and a standard deviation of <code>1</code> (bias-corrected standard-normal deviations). These deviations are then scaled by the level of recruitment variability specified in the OM with <span class="math inline">\(\sigma_r\)</span>. If you would like to specify your own deviations, you can pass them using <code>user_recdevs</code>. See the next section on <a href="#deterministic">self tests</a> for an example of <code>user_recdevs</code>.</p>
</div>
<div id="deterministic" class="section level2">
<h2 class="hasAnchor">
<a href="#deterministic" class="anchor"></a>Self test to check for bias</h2>
<p>Self testing is a crucial step of any simulation study to confirm that parameters are identifiable. One way to ensure the dynamics are what they were intended to be is to set up an EM that is similar to the OM and include minimal process and observation error in the OM. We recommend minimal and not zero error. Stability issues will arise in non-linear, integrated models that assume error structures when there is in fact none.</p>
<div id="setup-self-test" class="section level3">
<h3 class="hasAnchor">
<a href="#setup-self-test" class="anchor"></a>Setup self test</h3>
<p>We will start by setting up a 200 row (number of years) by 20 column (number of iterations) matrix of recruitment deviations, where all values are set to zero.</p>
<p>Then, we will set up OM and EM files with the standard deviation of recruitment variability, <code>SR_sigmaR</code> <span class="math inline">\(\sigma_R\)</span>, set to <code>0.001</code>. To do this, the data frame that controls the scenarios must specify <code>par_name = SR_sigmaR</code> (the Stock Synthesis parameter name) and <code>par_int = 0.001</code> (the initial value) for both <code>change_o</code> and <code>change_e</code> for the OM and EM, respectively. To minimize observation error on the survey index, we will create a standard deviation on the survey observation error of 0.001. Finally, we will fix <span class="math inline">\(M\)</span> at the true value and estimate it in phase 3 as we did before.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup_scenarios_defaults.html">setup_scenarios_defaults</a></span><span class="op">(</span>nscenarios <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"user_recdevs"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"matrix(0, nrow = 200, ncol = 20)"</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"co.par_name"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"SR_sigmaR"</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"co.par_int"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.001</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"ce.par_name"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"SR_sigmaR"</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"ce.par_int"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.001</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"ce.forecast_num"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"si.years.2"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"seq(60, 100, by = 2)"</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"si.sds_obs.2"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.001</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"ce.par_name"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"NatM_p_1_Fem_GP_1"</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"ce.par_int"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"ce.par_phase"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"scenarios"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D1-E100-F0-cod"</span>, <span class="st">"D1-E101-F0-M1-cod"</span><span class="op">)</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"bias_adjust"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="va">df</span><span class="op">[</span>, <span class="st">"hess_always"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></code></pre></div>
</div>
<div id="run-self-test" class="section level3">
<h3 class="hasAnchor">
<a href="#run-self-test" class="anchor"></a>Run self-test</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scname_det</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ss3sim.html">run_ss3sim</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="va">iterations</span>, simdf <span class="op">=</span> <span class="va">df</span><span class="op">)</span></code></pre></div>
</div>
<div id="checking-output" class="section level3">
<h3 class="hasAnchor">
<a href="#checking-output" class="anchor"></a>Checking output</h3>
<p>Check the model results to make sure that the EM returns the same parameters as the OM. <code><a href="../reference/get_results_all.html">get_results_all()</a></code> should be sufficient here, which will produce csv files that you can use to check parameter estimates. For more details see the <a href="#beautiful-output">section on model output</a>.</p>
</div>
</div>
</div>
<div id="beautiful-output" class="section level1">
<h1 class="hasAnchor">
<a href="#beautiful-output" class="anchor"></a>Beautiful output</h1>
<div id="csv-files" class="section level2">
<h2 class="hasAnchor">
<a href="#csv-files" class="anchor"></a>.csv files</h2>
<p><code><a href="../reference/get_results_all.html">get_results_all()</a></code> reads in a set of scenarios and combines the output into <code>.csv</code> files, e.g., <code>ss3sim_scalar.csv</code> and <code>ss3sim_ts.csv</code>. The <code>scalar</code> file contains values for which there is a single estimated value, e.g., MSY. The <code>ts</code> file refers to values for which there are time series of estimated values, e.g., biomass for each year.</p>
<p>Parameter names in these files will not always be the same across simulations because names are dependent on OM and EM settings. For example, an EM with age-specific natural mortality will have multiple natural mortality parameters each with a different name based on the age they pertain to. <code><a href="../reference/get_results_all.html">get_results_all()</a></code> accommodates this by using the parameter name assigned by Stock Synthesis rather than attempting to standardize names.</p>
<p>Originally, ss3sim provided the results using a wide-table format, with individual columns for each OM and EM parameter along with some summary information for each scenario. In May of 2020 we changed to providing results using a tidier long format.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/get_results_all.html">get_results_all</a></span><span class="op">(</span>
  overwrite_files <span class="op">=</span> <span class="cn">TRUE</span>,
  user_scenarios <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">scname</span>, <span class="va">scname_det</span><span class="op">)</span>
<span class="op">)</span>
<span class="co"># Read in the data frames stored in the csv files</span>
<span class="va">scalar_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"ss3sim_scalar.csv"</span><span class="op">)</span>
<span class="va">ts_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"ss3sim_ts.csv"</span><span class="op">)</span></code></pre></div>
<p>If you would like to follow along with the rest of the vignette without running the simulations detailed above, you can load a saved version of the output.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"scalar_dat"</span>, package <span class="op">=</span> <span class="st">"ss3sim"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"ts_dat"</span>, package <span class="op">=</span> <span class="st">"ss3sim"</span><span class="op">)</span></code></pre></div>
</div>
<div id="post-processing-of-results" class="section level2">
<h2 class="hasAnchor">
<a href="#post-processing-of-results" class="anchor"></a>Post-processing of results</h2>
<div id="calculate-the-relative-error-re" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-the-relative-error-re" class="anchor"></a>Calculate the relative error (RE)</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scalar_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_re.html">calculate_re</a></span><span class="op">(</span><span class="va">scalar_dat</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Warning in (function (..., deparse.level = 1) : number of columns of result is</span>
<span class="co">#&gt; not a multiple of vector length (arg 1)</span>
<span class="va">ts_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_re.html">calculate_re</a></span><span class="op">(</span><span class="va">ts_dat</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Warning in (function (..., deparse.level = 1) : number of columns of result is</span>
<span class="co">#&gt; not a multiple of vector length (arg 1)</span></code></pre></div>
</div>
<div id="merge-scalar-and-time-series" class="section level3">
<h3 class="hasAnchor">
<a href="#merge-scalar-and-time-series" class="anchor"></a>Merge scalar and time series</h3>
<p>The gradient information is in the scalar file. Merging the scalar and the time series can help add details to figures.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ts_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">ts_dat</span>, <span class="va">scalar_dat</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scenario"</span>, <span class="st">"iteration"</span>,
    <span class="st">"max_grad"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</div>
<div id="separate-the-deterministic-from-the-stochastic-runs" class="section level3">
<h3 class="hasAnchor">
<a href="#separate-the-deterministic-from-the-stochastic-runs" class="anchor"></a>Separate the deterministic from the stochastic runs</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scalar_dat_det</span> <span class="op">&lt;-</span> <span class="va">scalar_dat</span><span class="op">[</span><span class="va">scalar_dat</span><span class="op">$</span><span class="va">E</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"E100"</span>, <span class="st">"E101"</span><span class="op">)</span>, <span class="op">]</span>
<span class="va">scalar_dat_sto</span> <span class="op">&lt;-</span> <span class="va">scalar_dat</span><span class="op">[</span><span class="va">scalar_dat</span><span class="op">$</span><span class="va">E</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"E0"</span>, <span class="st">"E1"</span><span class="op">)</span>, <span class="op">]</span>
<span class="va">ts_dat_det</span> <span class="op">&lt;-</span> <span class="va">ts_dat</span><span class="op">[</span><span class="va">ts_dat</span><span class="op">$</span><span class="va">E</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"E100"</span>, <span class="st">"E101"</span><span class="op">)</span>, <span class="op">]</span>
<span class="va">ts_dat_sto</span> <span class="op">&lt;-</span> <span class="va">ts_dat</span><span class="op">[</span><span class="va">ts_dat</span><span class="op">$</span><span class="va">E</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"E0"</span>, <span class="st">"E1"</span><span class="op">)</span>, <span class="op">]</span>

<span class="va">scalar_dat_long</span> <span class="op">&lt;-</span> <span class="va">scalar_dat</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">scalar_dat_long</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"(.+)_re"</span>, <span class="st">"RE _\\1"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">scalar_dat_long</span><span class="op">)</span><span class="op">)</span>
<span class="va">scalar_dat_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span><span class="op">(</span><span class="va">scalar_dat_long</span>, sep <span class="op">=</span> <span class="st">" _"</span>,
  direction <span class="op">=</span> <span class="st">"long"</span>,
  varying <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">" _"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">scalar_dat_long</span><span class="op">)</span><span class="op">)</span>,
  idvar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scenario"</span>, <span class="st">"iteration"</span><span class="op">)</span>,
  timevar <span class="op">=</span> <span class="st">"parameter"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="boxplots" class="section level2">
<h2 class="hasAnchor">
<a href="#boxplots" class="anchor"></a>Boxplots</h2>
<p>Use the long data to create a multi-panel plot with ggplot2.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_boxplot.html">plot_boxplot</a></span><span class="op">(</span><span class="va">scalar_dat_long</span><span class="op">[</span>
  <span class="va">scalar_dat_long</span><span class="op">$</span><span class="va">parameter</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"depletion"</span>, <span class="st">"SSB_MSY"</span><span class="op">)</span> <span class="op">&amp;</span>
  <span class="va">scalar_dat_long</span><span class="op">$</span><span class="va">E</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"E100"</span>, <span class="st">"E101"</span><span class="op">)</span>, <span class="op">]</span>,
  x <span class="op">=</span> <span class="st">"D"</span>, y <span class="op">=</span> <span class="st">"RE"</span>, re <span class="op">=</span> <span class="cn">FALSE</span>,
  vert <span class="op">=</span> <span class="st">"E"</span>, horiz <span class="op">=</span> <span class="st">"parameter"</span>, print <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="introduction_files/figure-html/relative-error-boxplots-det-1.png" alt="Box plots of the relative error (RE) for deterministic runs. $M$ is fixed at the true value from the OM (E100) or estimated (E101)." width="480"><p class="caption">
Box plots of the relative error (RE) for deterministic runs. <span class="math inline">\(M\)</span> is fixed at the true value from the OM (E100) or estimated (E101).
</p>
</div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># see plot_points() for another plotting function</span></code></pre></div>
<p>While plotting the relative error in estimates of spawning biomass, one can add color to the time series according to the maximum gradient. Small values of the maximum gradient (approximately 0.001 or less) indicate that model convergence is likely. Larger values (greater than 1) indicate that model convergence is unlikely. Results of individual iterations are jittered around the vertical axis to aid in visualization. The following three blocks of code produce Figures~, , and .</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_lines.html">plot_lines</a></span><span class="op">(</span><span class="va">ts_dat_sto</span>, y <span class="op">=</span> <span class="st">"SpawnBio_re"</span>,
  vert <span class="op">=</span> <span class="st">"E"</span>, horiz<span class="op">=</span><span class="st">"D"</span>, print <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="st">"max_grad"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="introduction_files/figure-html/plot-sto-ts-1.png" alt="Time series of relative error in spawning stock biomass." width="672"><p class="caption">
Time series of relative error in spawning stock biomass.
</p>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_lines.html">plot_lines</a></span><span class="op">(</span><span class="va">ts_dat_sto</span>, y <span class="op">=</span> <span class="st">"SpawnBio_re"</span>,
  vert <span class="op">=</span> <span class="st">"E"</span>, horiz<span class="op">=</span><span class="st">"D"</span>, print <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="st">"max_grad"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="introduction_files/figure-html/ssb-ts-plots-1.png" alt="Spawning stock biomass time series." width="672"><p class="caption">
Spawning stock biomass time series.
</p>
</div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_boxplot.html">plot_boxplot</a></span><span class="op">(</span><span class="va">scalar_dat_long</span><span class="op">[</span>
  <span class="va">scalar_dat_long</span><span class="op">$</span><span class="va">parameter</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"depletion"</span>, <span class="st">"SSB_MSY"</span><span class="op">)</span> <span class="op">&amp;</span>
  <span class="va">scalar_dat_long</span><span class="op">$</span><span class="va">E</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"E0"</span>, <span class="st">"E1"</span><span class="op">)</span>, <span class="op">]</span>,
  x <span class="op">=</span> <span class="st">"D"</span>, y <span class="op">=</span> <span class="st">"RE"</span>, re <span class="op">=</span> <span class="cn">FALSE</span>,
  vert <span class="op">=</span> <span class="st">"E"</span>, horiz <span class="op">=</span> <span class="st">"parameter"</span>, print <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="introduction_files/figure-html/relative-error-boxplots-sto-1.png" alt="Box plots of relative error (RE) for stochastic runs. $M$ is fixed at the true value from the OM (E0) or estimated (E1). The standard deviation on the survey index observation error is 0.4 (D1) or 0.1 (D0), representing an increase in survey sampling effort." width="480"><p class="caption">
Box plots of relative error (RE) for stochastic runs. <span class="math inline">\(M\)</span> is fixed at the true value from the OM (E0) or estimated (E1). The standard deviation on the survey index observation error is 0.4 (D1) or 0.1 (D0), representing an increase in survey sampling effort.
</p>
</div>
</div>
</div>
<div id="stochasticity" class="section level1">
<h1 class="hasAnchor">
<a href="#stochasticity" class="anchor"></a>Stochasticity</h1>
<div id="obs-error" class="section level2">
<h2 class="hasAnchor">
<a href="#obs-error" class="anchor"></a>Generating observation error</h2>
<p><code>sample_*()</code> use the expected values from the OM output and work together to create the input <code>.dat</code> file for the EM. Note that the years/fleets to be sampled must be present in the OM data file. ss3sim does this data creation dynamically <a href="#change-data">using <code>change_data()</code></a>. But, in some cases adding information to the <code>.dat</code> file may need to be done manually. Currently ss3sim supports the sampling of the following types of data:</p>
<ul>
<li>indices of abundance with <code><a href="../reference/sample_index.html">sample_index()</a></code>,</li>
<li>length and age compositions with <code><a href="../reference/sample_lcomp.html">sample_lcomp()</a></code> and <code><a href="../reference/sample_agecomp.html">sample_agecomp()</a></code>,</li>
<li>mean length (size) at age <code><a href="../reference/sample_mlacomp.html">sample_mlacomp()</a></code>,</li>
<li>empirical weight at age with <code><a href="../reference/sample_wtatage.html">sample_wtatage()</a></code>, and</li>
<li>conditional age at length with <code><a href="../reference/sample_calcomp.html">sample_calcomp()</a></code>.</li>
</ul>
<p>In simulations, the true underlying dynamics of the population are known and therefore a variety of sampling techniques are possible. Ideal sampling, in the statistical sense, can be done easily. However, there is some question about the realism behind providing the model with this kind of data because it is unlikely to happen in practice <span class="citation">(Pennington et al. 2002)</span>. Thus, there is a need to be able to generate more realistic data. One way is to use flexible distributions, which allow the user to control the statistical properties, e.g., overdispersion of the data. Another option is to use unmodeled process error, typically in selectivity.</p>
<p>Under perfect mixing of fish and truly random sampling of the population, the age samples would be multinomial. However, in practice fish are never perfectly mixed because fish tend to aggregate by size and age <span class="citation">(e.g., Pennington et al. 2002)</span>. And, it is difficult to take random samples. Both of these sampling properties can cause the data to have more variance than expected, i.e., be overdispersed, and the effective sample size is smaller than expected <span class="citation">(Maunder 2011, Hulson et al. 2012)</span>. For example, if a multinomial likelihood is assumed for overdispersed data, the model puts too much weight on those data by thinking they should be less variable than they are, at the cost of fitting other data less well <span class="citation">(Maunder 2011)</span>. Analysts thus often “tune” their model to find a sample size, i.e., “effective sample size”, that is more appropriate than the “input sample size”. The effective sample size will in theory more accurately reflect the information in the composition data <span class="citation">(Francis and Hilborn 2011)</span>. In our case, we exactly control how the data are generated and specified in the EM, providing a large amount of flexibility to the user. What is optimal will depend on the questions addressed by a simulation and how the results are meant to be interpreted. We caution users to carefully consider how data are generated and fit.</p>
<div id="indices-of-abundance" class="section level3">
<h3 class="hasAnchor">
<a href="#indices-of-abundance" class="anchor"></a>Indices of abundance</h3>
<p><code><a href="../reference/sample_index.html">sample_index()</a></code> facilitates generating relative indices of abundance (catch-per-unit-effort (CPUE) data for fishery fleets). It samples from the biomass trends available for the different fleets to simulate the collection of CPUE and survey index data. The user can specify which fleets are sampled in which years and with what amount of noise. Different fleets will “see” different biomass trends due to differences in selectivity. Catchability for the OM is equal to one, <span class="math inline">\(q=1\)</span>, and thus, the indices are actually absolute indices of (spawning) biomass.</p>
<p>In practice, sampling from the abundance indices is relatively straightforward. The OM <code>.dat</code> file contains the annual biomass values for each fleet, and the <code>sample_index</code> function uses these true values as the mean of a distribution. The function uses a bias-corrected log-normal distribution with expected values given by the OM biomass and a user-provided standard deviation term that controls the level of variance.</p>
<p>More specifically, let</p>
<p><span class="math display">\[\begin{aligned}
  B_y&amp;=\text{the true (OM) biomass in year $y$}\newline
  \sigma_y&amp;=\text{the standard deviation provided by the user}\newline
  X\sim N(0, \sigma_y^2)&amp;=\text{a normal random variable}
\end{aligned}\]</span></p>
<p>then the sampled value, <span class="math inline">\(B_y^\text{obs}\)</span> is</p>
<p><span class="math display">\[B_y^\text{obs}=B_y e^{X-\sigma_y^2/2}\]</span></p>
<p>which has expected value <span class="math inline">\(\mathrm{E}\left[B_y^\text{obs}\right]=B_y\)</span> due to the bias adjustment term <span class="math inline">\(\sigma_y^2/2\)</span> (<code>SR_sigmaR</code> in Stock Synthesis). This process generates log-normal values centered at the true value. It is possible for the user to specify the amount of uncertainty, e.g., to mimic the amount of survey effort. But currently, it is not possible to induce bias in this process.</p>
<div id="effective-sample-sizes" class="section level4">
<h4 class="hasAnchor">
<a href="#effective-sample-sizes" class="anchor"></a>Effective sample sizes</h4>
<p>For index data, which are assumed by Stock Synthesis to follow a log-normal distribution, the weight of the data is determined by the CV of each point. As the CV increases, the data have less weight in the joint likelihood. This is equivalent to decreasing the effective sample size in other distributions. ss3sim sets these values automatically at the truth internally, although future versions may allow for more complex options. The user-supplied <span class="math inline">\(\sigma_y\)</span> term is written to the <code>.dat</code> file along with the sampled values. So, the EM has the correct level of uncertainty. Thus, the EM has unbiased estimates of both <span class="math inline">\(B_y\)</span> and the true <span class="math inline">\(\sigma_y\)</span> for all fleets in all years sampled.</p>
</div>
</div>
<div id="comps" class="section level3">
<h3 class="hasAnchor">
<a href="#comps" class="anchor"></a>Age and length compositions</h3>
<p><code><a href="../reference/sample_agecomp.html">sample_agecomp()</a></code> and <code><a href="../reference/sample_lcomp.html">sample_lcomp()</a></code> sample from the true age and length compositions using either a multinomial or Dirichlet distribution. The user can specify which fleets are sampled in which years and with what amount of noise (via sample size).</p>
<p>The following calculations are shown for how age-composition-data is sampled. But, the equations apply equally to how length-composition data is sampled as well. The multinomial distribution <span class="math inline">\(\mathbf{m} \sim \text{MN}\left(\mathbf{p}, n, A\right )\)</span> is defined as</p>
<p><span class="math display">\[\begin{aligned}
 \mathbf{m} &amp;= m_1, \ldots, m_A\\
  &amp;=\text{the number of fish observed in bin $a$}\\
  \mathbf{p}&amp;= p_1, \ldots, p_A\\
  &amp;=\text{the true proportion of fish in bin $a$}\\
  n&amp;=\text{sample size} \\
  A&amp;=\text{number of age bins}
\end{aligned}\]</span></p>
<p>In the case of Stock Synthesis, actual proportions are input as data. So, <span class="math inline">\(\mathbf{m}/n\)</span> is the distribution used instead of <span class="math inline">\(\mathbf{m}\)</span>. Thus, the variance of the estimated proportion for age bin <span class="math inline">\(a\)</span> is <span class="math inline">\(\mathrm{Var}\left[M_a/n\right]=p_aq_a/n\)</span>. Note that <span class="math inline">\(m_a/n\)</span> can only take on values in the set <span class="math inline">\(\{0, 1/n, 2/n, \ldots, 1\}\)</span>. With sufficiently large sample size this set approximates the real interval <span class="math inline">\([0,1]\)</span>. But, the key point being that only a finite set of rational values of <span class="math inline">\(m_a/n\)</span> are possible.</p>
<p>The multinomial, as described above, is based on assumptions of ideal sampling and is likely unrealistic, particularly with large sample sizes. One strategy to add realism is to allow for overdispersion.</p>
<div id="sampling-with-overdispersion" class="section level4">
<h4 class="hasAnchor">
<a href="#sampling-with-overdispersion" class="anchor"></a>Sampling with overdispersion</h4>
<p>Users can specify the level of overdispersion present in the sampled data through the argument <code>cpar</code>. <code>cpar</code> is the ratio of the standard deviation between a multinomial and Dirichlet distribution with the same probabilities and sample size. Thus, a value of 1 would be the same standard deviation, while 2 would be twice the standard deviation of a multinomial (overdispersed). The package also currently allows for specifying the effective sample sizes used as input for the EM separately from the sample sizes used to sample the data. See <code><a href="../reference/sample_agecomp.html">?sample_agecomp</a></code> and <code><a href="../reference/sample_lcomp.html">?sample_lcomp</a></code> for more detail.</p>
<p>This Dirichlet distribution has the same range and mean as the multinomial. But, the distribution has a different variance controlled by a parameter. The variance is determined exclusively by the cell probabilities and sample size n the multinomial, making it more flexible than the multinomial. Let <span class="math inline">\(\mathbf{d} \sim \text{Dirichlet}\left (\boldsymbol{\alpha}, A\right )\)</span> be a Dirichlet random vector. It is characterized by</p>
<p><span class="math display">\[\begin{aligned}
  \mathbf{d} &amp;= d_1, \ldots, d_A\\
  &amp;=\text{the proportion of fish observed in bin $a$}\\
  \boldsymbol{\alpha}&amp;= \alpha_1, \ldots, \alpha_A\\
  &amp;=\text{concentration parameters for the proportion of fish in bin $a$}\\
  A&amp;=\text{number of age bins}
\end{aligned}\]</span></p>
<p>When using the Dirichlet distribution to generate random samples, it is convenient to parameterize the vector of concentration parameters <span class="math inline">\(\boldsymbol{\alpha}\)</span> as <span class="math inline">\(\lambda \mathbf{p}\)</span> so that <span class="math inline">\(\alpha_a=\lambda p_a\)</span>. The mean of <span class="math inline">\(d_a\)</span> is then <span class="math inline">\(\mathrm{E}\left[d_a\right]=p_a\)</span>. The variance is <span class="math inline">\(\mathrm{Var}\left[d_a\right]=\frac{p_aq_a}{\lambda+1}\)</span>. The marginal distributions for the Dirichlet are beta distributed. In contrast to the multinomial, the Dirichlet generates points on the real interval <span class="math inline">\([0,1]\)</span>.</p>
<p>The following steps are used to generate overdispersed samples:</p>
<ul>
<li>Get the true proportions at age from OM for the number of age bins <span class="math inline">\(A\)</span>.</li>
<li>Determine a realistic sample size, say <span class="math inline">\(n=100\)</span>. Calculate the variance of the samples from a multinomial distribution, call it <span class="math inline">\(V_{m_a}\)</span>.</li>
<li>Specify a level, <span class="math inline">\(c\)</span>, that scales the standard deviation of the multinomial. Then <span class="math inline">\(\sqrt{V_{d_{a}}}=c\sqrt{V_{m_{a}}}\)</span> from which <span class="math inline">\(\lambda=n/c^2-1\)</span> can be solved. Samples from the Dirichlet with this value of <span class="math inline">\(\lambda\)</span> will then give the appropriate level of variance. For instance, we can generate samples with twice the standard deviation of the multinomial by setting <span class="math inline">\(c=2\)</span> (this is <code>cpar</code>).</li>
</ul>
</div>
<div id="effective-sample-sizes-1" class="section level4">
<h4 class="hasAnchor">
<a href="#effective-sample-sizes-1" class="anchor"></a>Effective sample sizes</h4>
<p>The term “effective sample size” (ESS) for Stock Synthesis often refers to the tuned sample size, right-weighted depending on the information contained in the data. These values are estimated after an initial run and then written to the .dat file and Stock Synthesis is run again <span class="citation">(Francis and Hilborn 2011)</span>. Perhaps a better term would be “input sample size” to contrast it with what was originally sampled.</p>
<p>In any case, the default behavior for both multinomial and Dirichlet generated composition data is to set the effective sample size automatically in <code>sample_*()</code>. In the case of the multinomial, the effective sample size is just the original sample size, i.e., how many fish were sampled, the number of sampled tows, etc. However, with the Dirichlet distribution, the effective sample size depends on the parameters passed to these functions and is automatically calculated internally and passed on to the <code>.dat</code> file. The effective sample size is calculated as <span class="math inline">\(N_{eff}=n/c^2\)</span>, where <span class="math inline">\(c\)</span> is <code>cpar</code>. Note that these values will not necessarily be integer-valued and Stock Synthesis handles this without issue.</p>
<p>If the effective sample size is known and passed to the EM, there is much similarity between the multinomial and Dirichlet methods for generating data. The main difference arises when sample sizes (<span class="math inline">\(n\)</span>) are small; in this case, the multinomial will be restricted to few potential values (i.e., <span class="math inline">\(0/n, 1/n, \ldots, n/n\)</span>), whereas the Dirichlet has values in <span class="math inline">\([0,1]\)</span>. Thus, without the Dirichlet it would be impossible to generate realistic values that would come about from highly overdispersed data with a large <span class="math inline">\(n\)</span>.</p>
<p>The ability to is specify the ESS was implemented to allow for users to explore data weighting issues. If you want to specify an input/effective sample size different that what is used in sampling, this is available via the <code>ESS</code> arguments of these two functions.</p>
</div>
</div>
<div id="mean-length-at-age" class="section level3">
<h3 class="hasAnchor">
<a href="#mean-length-at-age" class="anchor"></a>Mean length at age</h3>
<p>The ability to sample mean-length-at-age data exists in ss3sim. But, this sampling has not been thoroughly tested or used in a simulation before. Contact the developers for more information.</p>
</div>
<div id="conditional-age-at-length" class="section level3">
<h3 class="hasAnchor">
<a href="#conditional-age-at-length" class="anchor"></a>Conditional age at length</h3>
<p>Conditional age-at-length (CAAL) data is an alternative to age-composition data, when there are paired age and length observations of the same fish. CAAL data are inherently tied to the length compositions, e.g., as if a trip measured lengths and ages for all fish. In contrast to the age compositions, which were generated independently of the length data, e.g., as if one trip measured only ages and a second only lengths. Stock Synthesis has the capability to associate the measurements, and doing so has many appealing attributes. CAAL data are expected to be more informative about growth than marginal age-composition data. Although, to date, few studies have examined this data type <span class="citation">(He et al. 2015, Monnahan et al. 2015)</span>. See <code>?sample_calcomp()</code> for more details on the sampling process.</p>
</div>
</div>
<div id="pro-error" class="section level2">
<h2 class="hasAnchor">
<a href="#pro-error" class="anchor"></a>Generating process error</h2>
<p>Process error is incorporated into the OM in the form of deviates in recruitment (“recdevs”) from the stock-recruitment relationship. Unlike the observation error, the process error affects the population dynamics and thus must be done before running the OM.</p>
<p>These built-in recruitment deviations are standard normal deviates and are multiplied by <span class="math inline">\(\sigma_r\)</span> (recruitment standard deviation) as specified in the OM, and bias adjusted within the package. That is, <span class="math display">\[\begin{equation*}
  \text{recdev}_i=\sigma_r z_i-\sigma_r^2/2
\end{equation*}\]</span> where <span class="math inline">\(z_i\)</span> is a standard normal deviate and the bias adjustment term (<span class="math inline">\(\sigma_r^2/2\)</span>) makes the deviates have an expected value of 1 after exponentiation.</p>
<p>If the recruitment deviations are not specified, then the package will use these built-in recruitment deviations. Alternatively, you can specify your own recruitment deviations, via the argument <code>user_recdevs</code> to the top-level function <code>ss3sim_base</code>. Ensure that you pass a matrix with at least enough columns (iterations) and rows (years). The user-supplied recruitment deviations are used exactly as specified (i.e., not multiplied by <span class="math inline">\(\sigma_r\)</span> as specified in the Stock Synthesis model), and <strong>it is up to you to bias correct them manually</strong> by subtracting <span class="math inline">\(\sigma_r^2 / 2\)</span> as is done above. This functionality allows for flexibility in how the recruitment deviations are specified, for example <a href="#deterministic">running deterministic runs</a> or adding serial correlation.</p>
<p>Note that for both built-in and user-specified recdevs, ss3sim will reuse the same set of recruitment deviations for all iterations across scenarios. For example if you have two scenarios and run 100 iterations of each, the same set of recruitment deviations are used for iteration one for both those two scenarios.</p>
</div>
<div id="reproducibility" class="section level2">
<h2 class="hasAnchor">
<a href="#reproducibility" class="anchor"></a>Reproducibility</h2>
<p>In many cases, you may want to make the observation and process error reproducible. For instance, you may want to reuse process error so that differences between scenarios are not confounded with process error. More broadly, you may want to make a simulation reproducible on another machine by another user (such as a reviewer).</p>
<p>By default ss3sim sets a seed based on the iteration number. This will create the same recruitment deviations for a given iteration number. You can therefore avoid having the same recruitment deviations for a given iteration number by either specifying your own recruitment deviation matrix. This can be done using the <code>user_recdevs</code> argument or by changing the iteration numbers (e.g., using iterations 101 to 200 instead of 1 to 100). If you use the latter method, you must specify a vector of iterations instead of a single number. The vector will specify which numbers along a number line to use versus a single number leads to 1:x iterations being generated. If you want the different scenarios to have different process error you will need to make separate calls to <code>run_ss3sim</code> for each scenario.</p>
<p>The observation error seed affecting the sampling of data is set during the OM generation. Therefore, a given iteration-scenario-argument combination will generate repeatable results. Given that different arguments can generate different sampling routines, e.g., stochastically sampling or not sampling from the age compositions or sampling a different number of years, the observation error is not necessarily comparable across different arguments.</p>
</div>
</div>
<div id="detailed-features" class="section level1">
<h1 class="hasAnchor">
<a href="#detailed-features" class="anchor"></a>Detailed features</h1>
<div id="time-varying" class="section level2">
<h2 class="hasAnchor">
<a href="#time-varying" class="anchor"></a>Time-varying parameters in the OM</h2>
<p>ss3sim includes the capability for inducing time-varying changes in the OM using <code><a href="../reference/change_tv.html">change_tv()</a></code>. The package currently does not have built-in functions to turn on/off the estimation of time-varying parameters in the EM. However, it is possible to create versions of an EM with and without time-varying estimation of a parameter and specify each EM in <code>simdf</code> using the <code>em</code> column. This approach would allow for testing of differences between estimating a single, constant parameter versus time-varying estimation of the same parameter.</p>
<p><code><a href="../reference/change_tv.html">change_tv()</a></code> works by adding an environmental deviate (<span class="math inline">\(env\)</span>) to the base parameter (<span class="math inline">\(par\)</span>), creating a time varying parameter (<span class="math inline">\(par\)</span>) for each year (<span class="math inline">\(y\)</span>),</p>
<p><span class="math display">\[\begin{equation}
par_y = par + link * env_y.
\end{equation}\]</span></p>
<p><span class="math inline">\(link\)</span> is pre-specified to a value of one. <span class="math inline">\(par\)</span> is the base value for the given parameter, as defined by the INIT value in the <code>.ctl</code> file. For all catchability parameters (<span class="math inline">\(q\)</span>), the deviate will be added to the log transform of the base parameter using the following equation:</p>
<p><span class="math display">\[\begin{equation}
  \log(q_{y}) = \log(q) + link * env_{y}.
\end{equation}\]</span></p>
<p>The vector of deviates must contain one value for every year of the simulation and can be specified as zero for years in which the parameter does not deviate from the base parameter value.</p>
<p>Currently, <code><a href="../reference/change_tv.html">change_tv()</a></code> function only works to add time-varying properties to a time-invariant parameter. It cannot alter the properties of parameters that already vary with time. Also, it will not work with custom environmental linkages. Environmental linkages for all parameters in the OM must be declared by a single line, i.e., <code>0 #_custom_mg-env_setup (0/1)</code> prior to using <code><a href="../reference/change_tv.html">change_tv()</a></code>. Additionally, Stock Synthesis does not allow more than one stock recruit parameter to vary with time. If the <code>.ctl</code> file already has a stock recruit parameter that varies with time and you try to implement another, the function will fail.</p>
<p>To pass arguments to <code>change_tv</code> through <code>run_ss3sim</code> you need to create a column labeled <code>ct.&lt;name of parameter&gt;</code>. Where you have to change <code>name of parameter</code> to the parameter of interest. This structure, where the column name includes the parameter name, allows for multiple parameters to be time varying, you just have to use multiple columns. Each column holds code to generate a vector of time series information for a given parameter. The vectors are then combined into a named list that is passed to <code>change_tv_list</code> in <code><a href="../reference/change_tv.html">change_tv()</a></code>.</p>
</div>
<div id="change-data" class="section level2">
<h2 class="hasAnchor">
<a href="#change-data" class="anchor"></a>Adjusting the available OM data dynamically</h2>
<p>ss3sim can dynamically adjust the type of data available from the OM for sampling. For example, you might wish to sample conditional length-at-age in a certain bin structure for certain years and fleets. To do that, the OM will need to generate length and age data for appropriate years and fleets at a sufficiently fine bin size. However, the idea behind ss3sim is to avoid having to hand code many different versions of an OM that have only minor differences. One way around this would be to write an OM that included all possible data types for all possible years at an extremely fine bin structure. But, this can substantially slow down how quickly the OM runs in Stock Synthesis. Therefore, we made ss3sim capable of dynamically modifying the OM to include just the data types and quantities that are needed based on arguments that are passed to <code>sample_*()</code>. Internally, ss3sim uses <code><a href="../reference/calculate_data_units.html">calculate_data_units()</a></code> to generate a superset of all necessary fleet and year combinations. See <a href="#obs-error">the section below</a> for more information on these types of data.</p>
<p>The dynamic creation of available data is the default behavior of the package. In practice, this means the user does not need to manage which data types, fleets, or years are produced by the OM. The following rules are applied if the arguments to any sampling function are not <code>NULL</code>:</p>
<ul>
<li>If <code><a href="../reference/sample_agecomp.html">sample_agecomp()</a></code>, generate age-composition data</li>
<li>If <code><a href="../reference/sample_lcomp.html">sample_lcomp()</a></code>, generate length-composition data</li>
<li>If <code><a href="../reference/sample_mlacomp.html">sample_mlacomp()</a></code>, generate age-composition data and mean length-at-age data</li>
<li>If <code><a href="../reference/sample_calcomp.html">sample_calcomp()</a></code>, generate length- and age-composition data and conditional length-at-age data</li>
<li>If <code><a href="../reference/sample_wtatage.html">sample_wtatage()</a></code>, generate empirical weight-at-age, age-composition, and mean length-at-age data</li>
</ul>
<p>For example, if empirical weight-at-age data are to be sampled, <code><a href="../reference/change_data.html">change_data()</a></code> adds age-composition and mean length-at-age data to the OM data file.</p>
<p>Another feature of <code><a href="../reference/change_data.html">change_data()</a></code> is that it can modify the binning structure of the data (not the population-level bins). The ages and length bins in the data are specified in the arguments <code>len_bin</code> and <code>age_bin</code> in <code><a href="../reference/ss3sim_base.html">ss3sim_base()</a></code>. These bins are consistent across fleets, years, etc. Empirical weight-at-age data are a special case because they are generated in a separate file and use the population bins. Also, when either of these bin arguments are set to <code>NULL</code> (the default value), then the respective bins are taken from the OM.</p>
</div>
<div id="parallel" class="section level2">
<h2 class="hasAnchor">
<a href="#parallel" class="anchor"></a>Parallel computing with ss3sim</h2>
<p>ss3sim can easily run multiple scenarios in parallel to speed up simulations. To run a simulation in parallel, you need to register multiple cores or clusters using the package of your choice. Here, we recommend using the parallel package and provide an example for you. First, find out how many cores are on the computer and register a portion of those for parallel processing. Second, us an apply function to get the results from each scenario. Third, bring the results together and close the cluster.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>
<span class="va">ncls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"NUMBER_OF_PROCESSORS"</span><span class="op">)</span><span class="op">)</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"cl.cores"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">ncls</span> <span class="op">&lt;</span> <span class="fl">6</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">parSapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">scname</span>, <span class="va">scname_det</span><span class="op">)</span>, 
  <span class="va">get_results_scenario</span>, overwrite_files <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="../reference/get_results_all.html">get_results_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></code></pre></div>
<p>Note that if the simulation aborts for any reason while <code><a href="../reference/run_ss3sim.html">run_ss3sim()</a></code> is running in parallel, you may need to abort the left over parallel processes. On Windows, open the task manager (Ctrl-Shift-Esc) and close any R processes. On a Mac, open Activity Monitor and force quit any R processes. Also, if you are working with a local development version of <code>ss3sim</code> and you are on a Windows machine, you may not be able to run in parallel if you load the package with <code>devtools::load_all()</code>. Instead, do a full install with <code>devtools::install()</code> (and potentially restart R if ss3sim was already loaded).</p>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-anderson2014a">
<p>Anderson, S.C., Monnahan, C.C., Johnson, K.F., Ono, K., and Valero, J.L. 2014. Ss3sim: An R package for fisheries stock assessment simulation with Stock Synthesis. PLOS ONE <strong>9</strong>(4): e92725. doi: <a href="https://doi.org/10.1371/journal.pone.0092725">10.1371/journal.pone.0092725</a>.</p>
</div>
<div id="ref-francis2011">
<p>Francis, R.C., and Hilborn, R. 2011. Data weighting in statistical fisheries stock assessment models. Canadian Journal of Fisheries and Aquatic Sciences <strong>68</strong>(6): 1124–1138. NRC Research Press.</p>
</div>
<div id="ref-he2015">
<p>He, X., Field, J.C., Pearson, D.E., and Lefebvre, L.S. 2015. Age sample sizes and their effects on growth estimation and stock assessment outputs: Three case studies from u.s. West coast fisheries. Fisheries Research: –. doi: <a href="https://doi.org/10.1016/j.fishres.2015.08.018">10.1016/j.fishres.2015.08.018</a>.</p>
</div>
<div id="ref-hulson2012">
<p>Hulson, P.-J.F., Hanselman, D.H., and Quinn, T.J. 2012. Determining effective sample size in integrated age-structured assessment models. ICES Journal of Marine Science: Journal du Conseil <strong>69</strong>(2): 281–292. Oxford University Press.</p>
</div>
<div id="ref-johnson2014">
<p>Johnson, K.F., Monnahan, C.C., McGilliard, C.R., Vert-pre, K.A., Anderson, S.C., Cunningham, C.J., Hurtado-Ferro, F., Licandeo, R.R., Muradian, M.L., Ono, K., Szuwalski, C.S., Valero, J.L., Whitten, A.R., and Punt, A.E. 2015. Time-varying natural mortality in fisheries stock assessment models: Identifying a default approach. ICES Journal of Marine Science: Journal du Conseil <strong>72</strong>(1): 137–150. doi: <a href="https://doi.org/10.1093/icesjms/fsu055">10.1093/icesjms/fsu055</a>.</p>
</div>
<div id="ref-maunder2011">
<p>Maunder, M.N. 2011. Review and evaluation of likelihood functions for composition data in stock-assessment models: Estimating the effective sample size. Fisheries Research <strong>109</strong>(2): 311–319. Elsevier.</p>
</div>
<div id="ref-monnahan2015">
<p>Monnahan, C.C., Ono, K., Anderson, S.C., Rudd, M.B., Hicks, A.C., Hurtado-Ferro, F., Johnson, K.F., Kuriyama, P.T., Licandeo, R.R., Stawitz, C.C., Taylor, I.G., and Valero, J.L. 2015. The effect of length bin width on growth estimation in integrated age-structured stock assessments. Fisheries Research. doi: <a href="https://doi.org/10.1016/j.fishres.2015.11.002">10.1016/j.fishres.2015.11.002</a>.</p>
</div>
<div id="ref-ono2014">
<p>Ono, K., Licandeo, R., Muradian, M.L., Cunningham, C.J., Anderson, S.C., Hurtado-Ferro, F., Johnson, K.F., McGilliard, C.R., Monnahan, C.C., Szuwalski, C.S., Valero, J.L., Vert-Pre, K.A., Whitten, A.R., and Punt, A.E. 2015. The importance of length and age composition data in statistical age-structured models for marine species. ICES Journal of Marine Science: Journal du Conseil <strong>72</strong>(1): 31–43. doi: <a href="https://doi.org/10.1093/icesjms/fsu007">10.1093/icesjms/fsu007</a>.</p>
</div>
<div id="ref-pennington2002">
<p>Pennington, M., Burmeister, L.-M., Hjellvik, V., and others. 2002. Assessing the precision of frequency distributions estimated from trawl-survey samples. Fishery Bulletin <strong>100</strong>(1).</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kelli F. Johnson, Sean C. Anderson, Kathryn L. Doering, Cole C. Monnahan, Christine C. Stawitz, Ian G. Taylor.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
